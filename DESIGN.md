# 全アバター衣装自動調整ツール - 設計ドキュメント

## 1. プロジェクト構造

```
AvatarCostumeAutoAdjustTool/
├── Editor/
│   ├── AvatarCostumeAdjustTool.cs           # メインのエディタウィンドウ
│   ├── UI/
│   │   ├── MainWindow.cs                    # メインウィンドウのUI実装
│   │   ├── BoneMappingTab.cs                # ボーンマッピングタブのUI
│   │   ├── AdjustmentTab.cs                 # 調整タブのUI
│   │   └── SettingsTab.cs                   # 設定タブのUI
│   ├── Core/
│   │   ├── BoneMapping/
│   │   │   ├── BoneIdentifier.cs            # ボーン識別アルゴリズム
│   │   │   ├── NameBasedMapper.cs           # 名前ベースのボーンマッピング
│   │   │   ├── HierarchyBasedMapper.cs      # 階層ベースのボーンマッピング
│   │   │   ├── PositionBasedMapper.cs       # 位置ベースのボーンマッピング
│   │   │   └── MappingManager.cs            # マッピング管理
│   │   ├── Adjustment/
│   │   │   ├── BoneBasedAdjuster.cs         # ボーンベースの調整アルゴリズム
│   │   │   ├── MeshBasedAdjuster.cs         # メッシュベースの調整アルゴリズム
│   │   │   ├── FineAdjuster.cs              # 微調整機能
│   │   │   └── AdjustmentManager.cs         # 調整管理
│   │   └── Data/
│   │       ├── BoneData.cs                  # ボーン情報モデル
│   │       ├── MappingData.cs               # マッピング情報モデル
│   │       ├── BodyPartData.cs              # 身体部位情報モデル
│   │       ├── AdjustmentPreset.cs          # 調整プリセットモデル
│   │       └── DataManager.cs               # データ管理
│   ├── Utils/
│   │   ├── BoneUtils.cs                     # ボーン操作ユーティリティ
│   │   ├── MeshUtils.cs                     # メッシュ操作ユーティリティ
│   │   ├── HierarchyUtils.cs                # 階層操作ユーティリティ
│   │   ├── PathUtils.cs                     # パス操作ユーティリティ
│   │   ├── JsonUtils.cs                     # JSON操作ユーティリティ
│   │   └── EditorUIUtils.cs                 # エディタUI関連ユーティリティ
│   └── Resources/
│       ├── Icons/                           # アイコンリソース
│       ├── BoneNamingPatterns.json          # ボーン命名パターンデータ
│       └── BodyPartReferences.json          # 身体部位参照データ
└── Tests/
    ├── Editor/
    │   ├── BoneIdentifierTests.cs           # ボーン識別のテスト
    │   ├── BoneMappingTests.cs              # ボーンマッピングのテスト
    │   └── AdjustmentTests.cs               # 調整機能のテスト
    └── TestAssets/
        ├── TestAvatar.prefab                # テスト用アバター
        └── TestCostume.prefab               # テスト用衣装
```

## 2. 主要コンポーネント

### 2.1 ボーン識別・マッピングシステム

異なるボーン構造間の対応付けを行うシステム。以下の3つの方法を組み合わせてボーン対応を特定:

1. **名前ベースのマッピング** (優先度: 高)
   - 様々な命名規則を解析し、正規化されたボーン名に変換
   - 一般的な命名パターンを事前定義したデータベースを使用

2. **階層ベースのマッピング** (優先度: 中)
   - ボーンの親子関係を分析
   - 骨格構造内での相対的な位置づけを特定
   - 形態学的な特徴を用いた識別（例：脊椎の連鎖、指の構造など）

3. **位置ベースのマッピング** (優先度: 低)
   - ボーンの空間的位置関係を利用
   - 正規化された座標系でのボーンの相対位置を比較
   - クラスタリングアルゴリズムで近い位置のボーンを対応付け

### 2.2 衣装調整システム

#### 2.2.1 ボーンベースの調整
- スキンメッシュのボーン参照を自動更新
- ウェイトの再配分
- 欠落ボーンへの代替マッピング

#### 2.2.2 メッシュベースの調整
- アバターメッシュ形状に基づく衣装メッシュの変形
- 身体部位ごとの個別調整
- 参照点システムによる正確な変形

### 2.3 微調整システム
- スライダーベースのリアルタイム調整
- 部位別の詳細なオフセット設定
- プリセット保存・読み込み機能

### 2.4 ユーザーインターフェース
- タブ分けされた使いやすいインターフェース
- ボーンマッピングの視覚的表示
- ドラッグ＆ドロップによる簡単な操作

## 3. データモデル

### 3.1 BoneData
- ボーン名
- 正規化ボーン種類
- 階層パス
- 空間位置

### 3.2 MappingData
- アバターボーン → 衣装ボーン対応表
- マッピング信頼度
- マッピング方法（名前/階層/位置）
- 手動マッピングフラグ
- 除外ボーンリスト

### 3.3 BodyPartData
- メッシュ部位分類
- 参照点データ（中心、範囲、端点など）
- 調整パラメータ

### 3.4 AdjustmentPreset
- 基本スケール値
- 部位別微調整値
- プリセット名と説明

## 4. 処理フロー

### 4.1 メインフロー
1. アバターと衣装モデルの選択
2. ボーン構造解析
3. 自動ボーンマッピング生成
4. ユーザーによるマッピング確認・調整
5. 調整方法選択（ボーンベース/メッシュベース）
6. 衣装適用と初期調整
7. 微調整の適用
8. 結果の確定とプリセット保存（オプション）

### 4.2 ボーンマッピング生成フロー
1. 名前ベースのマッピング実行
2. 未マッピングのボーンに対して階層ベースのマッピング実行
3. 残りのボーンに対して位置ベースのマッピング実行
4. 手動設定済みマッピングの優先適用
5. 重要ボーンの欠落チェックとフォールバック設定

### 4.3 衣装適用フロー
1. 既存の衣装インスタンスの確認と削除
2. 新しい衣装インスタンスの作成
3. 選択された調整方法に基づく処理実行
4. 初期調整値の適用
5. エディタの更新と結果の表示

## 5. 拡張性設計

### 5.1 プラグインシステム
- 新たなマッピングアルゴリズムを追加可能なインターフェース設計
- カスタム調整アルゴリズムを組み込める拡張ポイント

### 5.2 プリセットシステム
- JSONベースのプリセット保存・読み込み
- アバターごとの調整設定管理

### 5.3 将来的な拡張
- 機械学習を用いたボーン推定（将来の拡張として）
- バッチ処理によるマルチアバター/マルチ衣装の一括処理

## 6. パフォーマンス考慮事項

### 6.1 最適化戦略
- メッシュ操作の非同期処理
- 大規模メッシュに対する段階的処理
- エディタUI更新の最適化

### 6.2 制限事項
- 高ポリゴンメッシュでのパフォーマンス低下可能性
- 特殊ボーン構造への対応限界
- 複雑な衣装デフォーメーションの制約
