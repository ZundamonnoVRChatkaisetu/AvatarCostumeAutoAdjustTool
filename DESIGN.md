# 全アバター衣装自動調整ツール - 設計ドキュメント

## 1. プロジェクト構造

```
AvatarCostumeAutoAdjustTool/
├── Editor/
│   ├── AvatarCostumeAdjustTool.cs           # メインのエディタウィンドウ
│   ├── AvatarCostumeAdjustTool.asmdef       # アセンブリ定義
│   ├── UI/
│   │   ├── BoneMappingTab.cs                # ボーンマッピングタブのUI
│   │   ├── AdjustmentTab.cs                 # 調整タブのUI
│   │   └── SettingsTab.cs                   # 設定タブのUI
│   ├── Core/
│   │   ├── BoneMapping/
│   │   │   ├── BoneIdentifier.cs            # ボーン識別アルゴリズム
│   │   │   ├── NameBasedMapper.cs           # 名前ベースのボーンマッピング
│   │   │   ├── HierarchyBasedMapper.cs      # 階層ベースのボーンマッピング
│   │   │   ├── PositionBasedMapper.cs       # 位置ベースのボーンマッピング
│   │   │   └── MappingManager.cs            # マッピング管理
│   │   ├── Adjustment/
│   │   │   ├── BoneBasedAdjuster.cs         # ボーンベースの調整アルゴリズム
│   │   │   ├── MeshBasedAdjuster.cs         # メッシュベースの調整アルゴリズム
│   │   │   ├── FineAdjuster.cs              # 微調整機能
│   │   │   ├── BodyPartAdjuster.cs          # 体の部位別調整機能
│   │   │   └── AdjustmentManager.cs         # 調整管理
│   │   └── Data/
│   │       ├── BoneData.cs                  # ボーン情報モデル
│   │       ├── MappingData.cs               # マッピング情報モデル
│   │       ├── AdjustmentSettings.cs        # 調整設定モデル
│   │       └── DataManager.cs               # データ管理
│   ├── Utils/
│   │   ├── JsonUtils.cs                     # JSON操作ユーティリティ
│   │   ├── EditorUtils.cs                   # エディタ関連ユーティリティ
│   │   └── MeshUtils.cs                     # メッシュ操作ユーティリティ
│   └── Resources/
│       ├── Icons/                           # アイコンリソース (未実装)
│       ├── BoneNamingPatterns.json          # ボーン命名パターンデータ
│       └── BodyPartReferences.json          # 身体部位参照データ
└── Tests/
    └── ...                                  # テスト関連 (未実装)
```

## 2. 実装状況

### 2.1 UIコンポーネント
- ✅ メインエディタウィンドウ
- ✅ ボーンマッピングタブ
- ✅ 調整タブ
- ✅ 設定タブ

### 2.2 ボーンマッピング機能
- ✅ ボーン識別
- ✅ 名前ベースのマッピング
- ✅ 階層ベースのマッピング
- ✅ 位置ベースのマッピング
- ✅ マッピング管理

### 2.3 調整機能
- ✅ ボーンベースの調整
- ✅ メッシュベースの調整
- ✅ 微調整機能
- ✅ 体の部位別調整機能
- ✅ 調整管理

### 2.4 データモデル
- ✅ ボーン情報モデル
- ✅ マッピング情報モデル
- ✅ 調整設定モデル
- ✅ データ管理

### 2.5 ユーティリティ
- ✅ JSON操作ユーティリティ
- ✅ エディタ関連ユーティリティ
- ✅ メッシュ操作ユーティリティ

### 2.6 リソース
- ❌ アイコンリソース (未実装)
- ✅ ボーン命名パターンデータ
- ✅ 身体部位参照データ

### 2.7 テスト
- ❌ ボーン識別のテスト (未実装)
- ❌ ボーンマッピングのテスト (未実装)
- ❌ 調整機能のテスト (未実装)

## 3. 注意点と制限事項

実装されたコードは基本的なフレームワークを提供していますが、実際のUnity環境での詳細な動作検証は行われていません。以下の制限事項があります：

1. **ヒューマノイドリグの取得**：
   - Unity EditorのAPIを使用した詳細なヒューマノイド情報の取得部分は簡易的な実装になっています。

2. **メッシュ変形**：
   - メッシュベースの調整は基本的なバウンディングボックスベースの簡易実装です。
   - 詳細なメッシュ形状解析と変形は実装されていません。

3. **リアルタイムプレビュー**：
   - SceneViewでのリアルタイムプレビュー機能は現在未実装です。

4. **パフォーマンス**：
   - 大規模なメッシュや複雑なボーン構造でのパフォーマンス最適化は行われていません。

5. **ボーン命名パターン**：
   - 事前定義のボーン命名パターンデータベースは実装されました。

## 4. 今後の開発予定

### 4.1 短期的な改善
- [ ] ヒューマノイドリグ取得の詳細実装
- [ ] メッシュ変形アルゴリズムの強化
- [ ] リアルタイムプレビュー機能の実装
- [x] ボーン命名パターンデータベースの実装
- [ ] パフォーマンス最適化

### 4.2 中期的な開発
- [ ] バッチ処理による一括適用機能
- [ ] 衣装のプリセット管理システム
- [ ] 衣装のクリッピング検出と修正
- [ ] ボーン影響の可視化ツール

### 4.3 長期的なビジョン
- [ ] 機械学習を用いたボーン推定
- [ ] 非人型モデルへの対応拡張
- [ ] 自動体型判別と推奨衣装サイズの提案
- [ ] 高度なメッシュ変形アルゴリズムの導入

## 5. 使用法（概要）

1. Unityエディタで「Tools > Avatar Costume Auto Adjust Tool」を選択
2. アバターと衣装のオブジェクトをそれぞれ選択
3. 「ボーンマッピング」タブで自動マッピングを実行
4. 必要に応じてマッピングを手動調整
5. 「衣装を着せる」ボタンをクリックして衣装をアバターに適用
6. 「調整」タブで衣装のフィット感を微調整
7. 設定をプリセットとして保存

## 6. 機能詳細

### 6.1 ボーンマッピング

ボーンマッピングは、異なるボーン構造を持つアバターと衣装間での対応関係を構築するプロセスです。このツールでは、以下の3つの方法を組み合わせて高精度なマッピングを実現します：

#### 6.1.1 名前ベースのマッピング
- 様々な命名規則に対応したボーン名の解析
- Levenshtein距離（編集距離）を用いた名前の類似度計算
- 左右識別子の標準化による正確なマッチング

#### 6.1.2 階層ベースのマッピング
- 親子関係に基づく階層的なボーン構造の解析
- 兄弟ボーンの関係性を考慮したマッピング
- 部分的なマッピング結果を活用した階層的推論

#### 6.1.3 位置ベースのマッピング
- 空間的な位置関係に基づくボーンの識別
- モデルサイズの正規化による適切な比較
- 体の部位情報を活用した位置的類似性の判定

### 6.2 衣装調整

衣装調整は、マッピングされたボーン情報を基に衣装をアバターに適合させるプロセスです。ツールでは以下の2つの方法を提供します：

#### 6.2.1 ボーンベースの調整
- スキンメッシュのボーン参照を自動更新
- ボーン階層構造に基づく適切な配置
- スキンメッシュレンダラーのボーン配列とバインドポーズの調整

#### 6.2.2 メッシュベースの調整
- メッシュの形状解析と部位分類
- バウンディングボックスを用いた基本的な形状適合
- 部位ごとの個別スケーリングと位置合わせ

### 6.3 微調整機能

衣装の基本的な適合後に細かい調整を行うための機能です：

- 全体スケールの調整
- 上半身/下半身のオフセット調整
- 左右の腕/脚の個別スケール調整
- 体の部位ごとの詳細な調整（スケール、オフセット、回転）
- プリセットの保存と読み込み

## 7. アーキテクチャ

### 7.1 モジュール構成

このツールは以下の主要モジュールで構成されています：

1. **UIモジュール**：ユーザーインターフェース関連のクラス群
2. **ボーンマッピングモジュール**：ボーン識別とマッピング関連のクラス群
3. **調整モジュール**：衣装の適合と調整関連のクラス群
4. **データモジュール**：データモデルとデータ管理のクラス群
5. **ユーティリティモジュール**：共通機能を提供するユーティリティクラス群

### 7.2 データフロー

1. **ボーン情報収集**：アバターと衣装からボーン情報を収集
2. **ボーンマッピング**：収集したボーン情報を基にマッピングを生成
3. **衣装適用**：マッピング情報を基に衣装をアバターに適用
4. **調整適用**：ユーザーの設定に基づいて衣装を調整
5. **プリセット管理**：調整設定の保存と読み込み

## 8. 今後の展望

このツールは、VRChatをはじめとするVR空間でのアバターカスタマイズをより簡単かつ柔軟にすることを目指しています。今後は以下の方向性で発展させていく予定です：

1. **ユーザビリティの向上**：より直感的なUIとリアルタイムプレビュー
2. **対応モデルの拡大**：様々なボーン構造や非人型モデルへの対応
3. **高度なアルゴリズム導入**：機械学習を用いたボーン推定や高度なメッシュ変形
4. **コミュニティ機能**：プリセットの共有やユーザー投稿のボーンマッピングデータベース

これらの展望を通じて、異なるモデル間での衣装共有をさらに容易にし、VR空間でのクリエイティブな表現の幅を広げることを目指します。
